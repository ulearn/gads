# Customer Match Dynamic List - Implementation Guide

## Overview

Automatically sync Sales Qualified Leads (SQLs) from HubSpot MySQL database to Google Ads Customer Match list for remarketing.

**Target:** ~4,000 contacts from Direct Sales pipeline stages
**Sync Frequency:** Hourly
**Data Retention:** 500 days from deal close date
**GDPR Compliant:** Excludes opted-out contacts

---

## Files Created

### 1. `/scripts/google/cust-match.js`
MySQL query module for fetching eligible contacts
- Matches HubSpot filters exactly (9 pipeline stages + exclusions)
- SHA256 hashing for Google Ads API
- GDPR opt-out handling
- 500-day retention window (self-pruning)

### 2. `/scripts/google/create-customer-match-list.js`
One-time setup script to create the Google Ads user list
- Creates Customer Match list with 18-month membership lifespan
- Returns User List ID for .env configuration

### 3. `/scripts/google/sync-customer-match.js`
Hourly sync script (cron job)
- Incremental sync (add new, remove old contacts)
- Cache-based change detection
- Batch processing (up to 5,000 contacts per job)
- Error handling with partial failure support

---

## Setup Instructions

### Step 1: Create the Customer Match List (One-Time)

```bash
cd /home/hub/public_html/gads
node scripts/google/create-customer-match-list.js
```

**Expected Output:**
```
✅ Customer Match list created successfully!

User List ID: 123456789

NEXT STEPS:
1. Add this to your .env file:
   CUSTOMER_MATCH_LIST_ID=123456789
```

### Step 2: Add Configuration to .env

```bash
# Add to /home/hub/public_html/gads/.env
CUSTOMER_MATCH_LIST_ID=123456789  # From step 1
GADS_ACCOUNT_ID=1051706978        # Your Google Ads account
```

### Step 3: Initial Upload (One-Time)

```bash
node scripts/google/sync-customer-match.js --initial
```

This uploads all ~4,000 eligible contacts to Google Ads.

**Processing Time:** 12-48 hours for Google to populate the list

---

## Ongoing Sync (Cron Jobs)

### A. HubSpot → MySQL Sync (Update Existing Cron)

**File:** Your existing HubSpot sync script
**Frequency:** Every 30 minutes
**Crontab:**
```cron
*/30 * * * * /path/to/hubspot-sync-script.sh >> /var/log/hubspot-sync.log 2>&1
```

### B. MySQL → Google Ads Sync (New Cron)

**File:** `/scripts/google/sync-customer-match.js`
**Frequency:** Hourly (run after MySQL sync)
**Crontab:**
```cron
15 * * * * cd /home/hub/public_html/gads && /usr/bin/node scripts/google/sync-customer-match.js >> /var/log/customer-match-sync.log 2>&1
```

**Note:** Runs at :15 past each hour (15 minutes after MySQL sync at :00 or :30)

---

## How It Works

### Pipeline Stages Included

| Stage | HubSpot ID | Count* |
|-------|------------|--------|
| INBOX | `appointmentscheduled` | ~4 |
| SEQUENCED | `113151423` | ~76 |
| ENGAGING | `qualifiedtobuy` | ~112 |
| RESPONSIVE | `767120827` | ~21 |
| ADVISING | `presentationscheduled` | ~4 |
| NEGOTIATION | `decisionmakerboughtin` | ~13 |
| TRIAL | `111070952` | ~1 |
| CONTRACT | `contractsent` | ~23 |
| LOST | `closedlost` | ~3,800** |

**Active Pipeline Total: ~252 contacts*
***LOST (<500 days, valid reasons): ~3,800 contacts*

### Exclusions

**Lost Reasons Excluded:**
- `unsupported_territory` (272 contacts)
- `Unqualified Lead` (1,276 contacts)
- `Spam` (if any)

**Automatic Filters:**
- Deal close date > 500 days old
- Contacts with `hs_email_optout = 1`

### Data Flow

```
HubSpot → MySQL (every 30 min)
    ↓
MySQL Query (pipeline stages + filters)
    ↓
SHA256 Hash (email + phone)
    ↓
Google Ads OfflineUserDataJob (hourly)
    ↓
Customer Match List (~4,000 contacts)
```

---

## Monitoring

### Check Sync Status

```bash
# View latest sync results
tail -100 /var/log/customer-match-sync.log

# Check cache file
cat /home/hub/public_html/gads/.cache/customer-match-sync.json
```

### Google Ads UI

1. Go to **Tools & Settings** → **Shared Library** → **Audience Manager**
2. Find list: **"SQL Pipeline Contacts - Dynamic"**
3. Check **List Size** (should be ~4,000+)
4. **Match Rate:** Expect 30-70% depending on data quality
5. **Status:** Must be 1,000+ members to use for targeting

### Troubleshooting

**Issue:** Sync fails with "User list not found"
**Solution:** Verify `CUSTOMER_MATCH_LIST_ID` in .env

**Issue:** 0 contacts uploaded
**Solution:** Check MySQL query returns results:
```bash
node -e "
const {queryEligibleContacts} = require('./scripts/google/cust-match.js');
queryEligibleContacts({verbose: true}).then(c => console.log('Found:', c.length));
"
```

**Issue:** Google Ads API quota exceeded
**Solution:** Reduce sync frequency to every 2-3 hours

---

## Maintenance

### Quarterly Prune (Future Enhancement)

Currently **self-pruning** via 500-day retention window in SQL query.

Optional: Manual cleanup of very old contacts
```bash
# TODO: Create quarterly prune script
# Removes contacts with closedate > 500 days from Google Ads
```

### Update Pipeline Stages

Edit `/scripts/google/cust-match.js`:
```javascript
const TARGET_STAGES = [
  'appointmentscheduled',  // Add/remove stages here
  '113151423',
  // ...
];
```

---

## Technical Details

### Google Ads Customer Match Requirements

- **Minimum List Size:** 1,000 contacts (for targeting)
- **Processing Time:** 12-48 hours to populate
- **Match Rate:** 30-70% (Google matches hashed emails/phones)
- **Membership Lifespan:** 540 days (18 months backstop)
- **Data Format:** SHA256 hashed emails/phones

### Hashing

```javascript
// Email: lowercase, trim, SHA256
email.trim().toLowerCase() → SHA256 → hash

// Phone: digits only, SHA256
phone.replace(/\D/g, '') → SHA256 → hash
```

### Batch Limits

- **Max per OfflineUserDataJob:** 10,000 operations
- **Current batch size:** 5,000 (configurable in sync script)
- **API Rate Limit:** ~500,000 operations/day

---

## Files Structure

```
/home/hub/public_html/gads/
├── scripts/google/
│   ├── cust-match.js                    # MySQL query module
│   ├── create-customer-match-list.js    # One-time setup
│   ├── sync-customer-match.js           # Hourly sync (cron)
│   └── README-CustomerMatch.md          # This file
├── .cache/
│   └── customer-match-sync.json         # Sync state cache
└── .env                                 # Configuration (add CUSTOMER_MATCH_LIST_ID)
```

---

## Next Steps

1. ✅ MySQL query module created
2. ✅ One-time setup script created
3. ✅ Hourly sync script created
4. ⏳ **Run one-time setup** (create list)
5. ⏳ **Add list ID to .env**
6. ⏳ **Run initial upload**
7. ⏳ **Setup cron job for hourly sync**
8. ⏳ **Monitor for 48 hours**

---

## Support

Questions? Check:
- Google Ads API Docs: https://developers.google.com/google-ads/api/docs/remarketing/audience-types/customer-match
- Error Logs: `/var/log/customer-match-sync.log`
- Cache File: `.cache/customer-match-sync.json`
