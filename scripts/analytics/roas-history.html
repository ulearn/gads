<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìà ROAS History | Timeseries Chart</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .back-btn {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
            color: white;
            text-decoration: none;
            padding: 12px 25px;
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            transition: transform 0.2s ease;
            margin-bottom: 20px;
        }

        .back-btn:hover {
            transform: scale(1.05);
        }

        .controls-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: end;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
        }

        .control-input {
            padding: 10px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .control-input:focus {
            border-color: #667eea;
        }

        .select2-container--default .select2-selection--multiple {
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            min-height: 42px;
            padding: 5px;
        }

        .apply-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: transform 0.2s ease;
        }

        .apply-btn:hover {
            transform: scale(1.05);
        }

        .quick-btn {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: 2px solid #667eea;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .quick-btn:hover {
            background: #667eea;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .roas-value { color: #667eea; }
        .spend-value { color: #e74c3c; }
        .revenue-value { color: #27ae60; }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .chart-wrapper {
            position: relative;
            height: 500px;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
            font-size: 1.2rem;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .info {
            background: #3498db;
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/gads/" class="back-btn">‚Üê Back to Dashboard</a>

        <div class="header">
            <h1>üìà ROAS History - Timeseries</h1>
            <p>
                <strong>ROAS performance over time.</strong>
                X-axis = Time | Y-axis = ROAS. Filter by date range, status, and campaigns.
            </p>
        </div>

        <div class="controls-panel">
            <div class="controls-grid">
                <div class="control-group">
                    <label>Date Range</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="date" id="startDate" class="control-input" style="flex: 1;">
                        <span style="color: #7f8c8d;">to</span>
                        <input type="date" id="endDate" class="control-input" style="flex: 1;">
                    </div>
                </div>

                <div class="control-group">
                    <label>Status</label>
                    <select id="statusFilter" class="control-input">
                        <option value="active">Active</option>
                        <option value="paused">Paused</option>
                        <option value="all">All</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Granularity</label>
                    <select id="granularityFilter" class="control-input">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Campaigns (Optional)</label>
                    <select id="campaignFilter" class="control-input" multiple="multiple" style="width: 100%;">
                    </select>
                </div>

                <div class="control-group">
                    <label>&nbsp;</label>
                    <button class="apply-btn" onclick="loadTimeseries()">Apply Filters</button>
                </div>
            </div>

            <div class="control-group" style="margin-top: 15px;">
                <label>Quick Ranges</label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="quick-btn" onclick="setQuickRange(7)">7 Days</button>
                    <button class="quick-btn" onclick="setQuickRange(30)">30 Days</button>
                    <button class="quick-btn" onclick="setQuickRange(60)">60 Days</button>
                    <button class="quick-btn" onclick="setQuickRange(90)">90 Days</button>
                </div>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid" style="display: none;">
            <div class="stat-card">
                <div class="stat-value roas-value" id="roasValue">--</div>
                <div class="stat-label">Overall ROAS</div>
            </div>
            <div class="stat-card">
                <div class="stat-value spend-value" id="spendValue">--</div>
                <div class="stat-label">Total Spend</div>
            </div>
            <div class="stat-card">
                <div class="stat-value revenue-value" id="revenueValue">--</div>
                <div class="stat-label">Total Revenue</div>
            </div>
        </div>

        <div id="loadingSpinner" class="loading" style="display: none;">
            <div>üîÑ Loading timeseries data...</div>
        </div>

        <div id="errorContainer"></div>

        <div class="chart-container" id="chartContainer" style="display: none;">
            <div style="border-bottom: 2px solid #ecf0f1; padding-bottom: 15px; margin-bottom: 20px;">
                <h2 style="font-size: 1.5rem; color: #2c3e50; font-weight: 600;">ROAS Over Time</h2>
            </div>
            <div class="chart-wrapper">
                <canvas id="roasChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let roasChart;
        let allCampaigns = [];

        function getDefaultDates() {
            const end = new Date();
            const start = new Date();
            start.setDate(start.getDate() - 30);
            return {
                start: start.toISOString().split('T')[0],
                end: end.toISOString().split('T')[0]
            };
        }

        function setQuickRange(days) {
            const end = new Date();
            const start = new Date();
            start.setDate(start.getDate() - days);
            document.getElementById('startDate').value = start.toISOString().split('T')[0];
            document.getElementById('endDate').value = end.toISOString().split('T')[0];
        }

        async function loadCampaignList() {
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const status = document.getElementById('statusFilter').value;

                if (!startDate || !endDate) return;

                const response = await fetch('/gads/analytics/roas-revenue-campaigns?startDate=' + startDate + '&endDate=' + endDate + '&status=' + status);
                const data = await response.json();

                if (data.success && data.campaigns) {
                    allCampaigns = data.campaigns;

                    const campaignFilter = $('#campaignFilter');
                    campaignFilter.empty();

                    data.campaigns.forEach(campaign => {
                        campaignFilter.append(new Option(campaign.campaign_name, campaign.campaign_name));
                    });

                    campaignFilter.select2({
                        placeholder: 'All campaigns (or select specific)',
                        allowClear: true
                    });
                }
            } catch (error) {
                console.error('Error loading campaigns:', error);
            }
        }

        async function loadTimeseries() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const status = document.getElementById('statusFilter').value;
            const granularity = document.getElementById('granularityFilter').value;
            const selectedCampaigns = $('#campaignFilter').val() || [];

            const loadingSpinner = document.getElementById('loadingSpinner');
            const errorContainer = document.getElementById('errorContainer');
            const chartContainer = document.getElementById('chartContainer');
            const statsGrid = document.getElementById('statsGrid');

            if (!startDate || !endDate) {
                errorContainer.innerHTML = '<div class="error">‚ö†Ô∏è Please select both start and end dates</div>';
                return;
            }

            loadingSpinner.style.display = 'block';
            errorContainer.innerHTML = '';
            chartContainer.style.display = 'none';
            statsGrid.style.display = 'none';

            try {
                let url = '/gads/analytics/roas-history-timeseries?startDate=' + startDate + '&endDate=' + endDate + '&status=' + status + '&granularity=' + granularity;

                if (selectedCampaigns.length > 0) {
                    url += '&campaigns=' + encodeURIComponent(JSON.stringify(selectedCampaigns));
                }

                console.log('üìà Loading timeseries:', url);

                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('API error: ' + response.status);
                }

                const data = await response.json();
                console.log('‚úÖ Timeseries loaded:', data);

                if (!data.success) {
                    throw new Error(data.error || 'Failed to load data');
                }

                updateStats(data.summary);
                updateChart(data.campaigns, granularity);

                chartContainer.style.display = 'block';
                statsGrid.style.display = 'grid';
                loadingSpinner.style.display = 'none';

            } catch (error) {
                console.error('‚ùå Error:', error);
                loadingSpinner.style.display = 'none';
                errorContainer.innerHTML = '<div class="error">‚ùå Error: ' + error.message + '</div>';
            }
        }

        function updateStats(summary) {
            document.getElementById('roasValue').textContent = summary.overall_roas.toFixed(2) + ':1';
            document.getElementById('spendValue').textContent = '‚Ç¨' + summary.total_spend.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('revenueValue').textContent = '‚Ç¨' + summary.total_revenue.toLocaleString(undefined, {maximumFractionDigits: 0});
        }

        function updateChart(campaignsData, granularity) {
            const ctx = document.getElementById('roasChart').getContext('2d');

            if (roasChart) {
                roasChart.destroy();
            }

            // Get all unique dates across all campaigns
            const allDates = new Set();
            Object.values(campaignsData).forEach(campaignTimeseries => {
                campaignTimeseries.forEach(point => {
                    allDates.add(point.date);
                });
            });

            const sortedDates = Array.from(allDates).sort();

            // Format labels
            const labels = sortedDates.map(dateStr => {
                const date = new Date(dateStr);
                if (granularity === 'monthly') {
                    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
                } else if (granularity === 'weekly') {
                    return 'Week of ' + date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                } else {
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
            });

            // Color palette for campaigns
            const colors = [
                '#667eea', '#27ae60', '#e74c3c', '#f39c12', '#9b59b6',
                '#3498db', '#1abc9c', '#e67e22', '#34495e', '#16a085'
            ];

            // Build datasets - one line per campaign
            const datasets = [];
            let colorIndex = 0;

            Object.entries(campaignsData).forEach(([campaignName, timeseries]) => {
                const color = colors[colorIndex % colors.length];

                // Create data array aligned with sortedDates
                const roasData = sortedDates.map(dateStr => {
                    const point = timeseries.find(p => p.date === dateStr);
                    return point ? point.roas : null;
                });

                datasets.push({
                    label: campaignName,
                    data: roasData,
                    borderColor: color,
                    backgroundColor: color.replace(')', ', 0.1)').replace('rgb', 'rgba'),
                    tension: 0.4,
                    borderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    spanGaps: false
                });

                colorIndex++;
            });

            roasChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'ROAS'
                            },
                            min: 0,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + ':1';
                                }
                            }
                        }
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìà ROAS History Timeseries page loaded');

            const defaults = getDefaultDates();
            document.getElementById('startDate').value = defaults.start;
            document.getElementById('endDate').value = defaults.end;

            $('#campaignFilter').select2({
                placeholder: 'All campaigns (or select specific)',
                allowClear: true
            });

            // Load campaign list and initial chart
            loadCampaignList().then(() => loadTimeseries());

            // Reload campaigns when date/status changes
            document.getElementById('startDate').addEventListener('change', loadCampaignList);
            document.getElementById('endDate').addEventListener('change', loadCampaignList);
            document.getElementById('statusFilter').addEventListener('change', loadCampaignList);
        });
    </script>
</body>
</html>
