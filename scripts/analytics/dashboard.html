<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Ads Pipeline Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function Dashboard() {
            // Initialize with last 30 days
            const getDefaultDates = () => {
                const end = new Date();
                const start = new Date();
                start.setDate(start.getDate() - 30);
                return {
                    start: start.toISOString().split('T')[0],
                    end: end.toISOString().split('T')[0]
                };
            };

            const defaults = getDefaultDates();
            
            // State
            const [startDate, setStartDate] = useState(defaults.start);
            const [endDate, setEndDate] = useState(defaults.end);
            const [analysisMode, setAnalysisMode] = useState('pipeline');
            const [loading, setLoading] = useState(false);
            const [data, setData] = useState(null);
            const [error, setError] = useState(null);

            // Fetch data
            const fetchData = async () => {
                if (!startDate || !endDate) return;
                
                setLoading(true);
                setError(null);
                
                try {
                    const params = new URLSearchParams({
                        mode: analysisMode,
                        startDate: startDate,
                        endDate: endDate
                    });

                    // Fetch all data
                    const [summaryRes, campaignsRes, territoriesRes] = await Promise.all([
                        fetch(`/gads/analytics/dashboard-data?${params}`),
                        fetch(`/gads/analytics/campaigns?${params}`),
                        fetch(`/gads/analytics/territories?${params}`)
                    ]);

                    if (!summaryRes.ok || !campaignsRes.ok || !territoriesRes.ok) {
                        throw new Error('API request failed');
                    }

                    const [summary, campaigns, territories] = await Promise.all([
                        summaryRes.json(),
                        campaignsRes.json(),
                        territoriesRes.json()
                    ]);

                    // Check for API errors
                    if (!summary.success) throw new Error(summary.error || 'Summary failed');
                    if (!campaigns.success) throw new Error(campaigns.error || 'Campaigns failed');
                    if (!territories.success) throw new Error(territories.error || 'Territories failed');

                    setData({
                        summary: summary.summary,
                        campaigns: campaigns.campaigns,
                        territories: territories.territories,
                        period: summary.period
                    });

                    // Debug: Check for discrepancy
                    const totalWonFromCampaigns = campaigns.campaigns.reduce((sum, c) => sum + (c.wonDeals || 0), 0);
                    const overviewWon = summary.summary.wonDeals || 0;
                    
                    console.log(`Campaign check:`, {
                        overview_won: overviewWon,
                        campaigns_won: totalWonFromCampaigns,
                        campaigns_with_won: campaigns.campaigns.filter(c => c.wonDeals > 0).length,
                        all_campaigns: campaigns.campaigns.length
                    });

                } catch (err) {
                    console.error('Error fetching data:', err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            // Quick date setters
            const setQuickRange = (days) => {
                const end = new Date();
                const start = new Date();
                start.setDate(start.getDate() - days);
                setStartDate(start.toISOString().split('T')[0]);
                setEndDate(end.toISOString().split('T')[0]);
            };

            // Apply button click
            const handleApply = () => {
                fetchData();
            };

            // Format helpers
            const formatNumber = (num) => {
                return new Intl.NumberFormat().format(num || 0);
            };

            const formatCurrency = (num) => {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'EUR',
                    minimumFractionDigits: 0
                }).format(num || 0);
            };

            // Initial load
            useEffect(() => {
                fetchData();
            }, []);

            return (
                <div className="min-h-screen bg-gray-50 p-6">
                    {/* Header */}
                    <div className="mb-8">
                        <h1 className="text-3xl font-bold text-gray-900 mb-4">
                            Google Ads Pipeline Dashboard
                        </h1>
                        
                        {/* Controls */}
                        <div className="bg-white p-4 rounded-lg shadow mb-4">
                            <div className="flex flex-wrap items-center gap-4">
                                {/* Date inputs */}
                                <div className="flex items-center gap-2">
                                    <input
                                        type="date"
                                        value={startDate}
                                        onChange={(e) => setStartDate(e.target.value)}
                                        className="px-3 py-2 border rounded"
                                    />
                                    <span>to</span>
                                    <input
                                        type="date"
                                        value={endDate}
                                        onChange={(e) => setEndDate(e.target.value)}
                                        className="px-3 py-2 border rounded"
                                    />
                                </div>

                                {/* Mode selector */}
                                <select
                                    value={analysisMode}
                                    onChange={(e) => setAnalysisMode(e.target.value)}
                                    className="px-3 py-2 border rounded"
                                >
                                    <option value="pipeline">Pipeline Mode</option>
                                    <option value="revenue">Revenue Mode</option>
                                </select>

                                {/* Apply button */}
                                <button
                                    onClick={handleApply}
                                    disabled={loading}
                                    className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50"
                                >
                                    {loading ? 'Loading...' : 'Apply'}
                                </button>

                                {/* Quick ranges */}
                                <div className="flex gap-2">
                                    <button
                                        onClick={() => { setQuickRange(7); setTimeout(fetchData, 100); }}
                                        className="px-3 py-1 text-sm bg-gray-100 rounded hover:bg-gray-200"
                                    >
                                        7d
                                    </button>
                                    <button
                                        onClick={() => { setQuickRange(30); setTimeout(fetchData, 100); }}
                                        className="px-3 py-1 text-sm bg-gray-100 rounded hover:bg-gray-200"
                                    >
                                        30d
                                    </button>
                                    <button
                                        onClick={() => { setQuickRange(60); setTimeout(fetchData, 100); }}
                                        className="px-3 py-1 text-sm bg-gray-100 rounded hover:bg-gray-200"
                                    >
                                        60d
                                    </button>
                                    <button
                                        onClick={() => { setQuickRange(90); setTimeout(fetchData, 100); }}
                                        className="px-3 py-1 text-sm bg-gray-100 rounded hover:bg-gray-200"
                                    >
                                        90d
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Mode description */}
                        <div className="bg-blue-50 border border-blue-200 rounded p-3 text-sm text-blue-800">
                            {analysisMode === 'pipeline' 
                                ? '📊 Pipeline Mode: Shows deals from contacts created in date range'
                                : '💰 Revenue Mode: Shows deals that closed in date range'}
                        </div>
                    </div>

                    {/* Error display */}
                    {error && (
                        <div className="bg-red-50 border border-red-200 rounded p-4 mb-4 text-red-700">
                            Error: {error}
                        </div>
                    )}

                    {/* Loading state */}
                    {loading && (
                        <div className="text-center py-8">
                            <div className="text-4xl mb-4">🔄</div>
                            <p>Loading dashboard data...</p>
                        </div>
                    )}

                    {/* Data display */}
                    {data && !loading && (
                        <>
                            {/* Metrics cards */}
                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
                                <div className="bg-white p-4 rounded shadow">
                                    <div className="text-sm text-gray-600">GAd Clicks</div>
                                    <div className="text-2xl font-bold text-blue-600">
                                        {formatNumber(data.summary.gad_clicks)}
                                    </div>
                                </div>
                                <div className="bg-white p-4 rounded shadow">
                                    <div className="text-sm text-gray-600">GAd CTAs</div>
                                    <div className="text-2xl font-bold text-indigo-600">
                                        {formatNumber(data.summary.gad_ctas)}
                                    </div>
                                </div>
                                <div className="bg-white p-4 rounded shadow">
                                    <div className="text-sm text-gray-600">MQLs Created</div>
                                    <div className="text-2xl font-bold text-purple-600">
                                        {formatNumber(data.summary.totalContacts)}
                                    </div>
                                </div>
                                <div className="bg-white p-4 rounded shadow">
                                    <div className="text-sm text-gray-600">MQLs Failed</div>
                                    <div className="text-2xl font-bold text-red-600">
                                        {formatNumber(data.summary.failed_validation)}
                                    </div>
                                    <div className="text-xs text-gray-500">
                                        {data.summary.burn_rate}% burn rate
                                    </div>
                                </div>
                                <div className="bg-white p-4 rounded shadow">
                                    <div className="text-sm text-gray-600">SQLs → Deals</div>
                                    <div className="text-2xl font-bold text-green-600">
                                        {formatNumber(data.summary.contactsWithDeals)} → {formatNumber(data.summary.totalDeals)}
                                    </div>
                                    <div className="text-xs text-gray-500">
                                        {data.summary.conversionRate}% SQL rate
                                    </div>
                                </div>
                                <div className="bg-white p-4 rounded shadow">
                                    <div className="text-sm text-gray-600">Deals WON</div>
                                    <div className="text-2xl font-bold text-green-600">
                                        {formatNumber(data.summary.wonDeals)}
                                    </div>
                                    <div className="text-xs text-gray-500">
                                        Lost: {formatNumber(data.summary.lostDeals)}
                                    </div>
                                </div>
                            </div>

                            {/* Campaign cards - SHOW ALL WITH WON DEALS */}
                            <div className="mb-8">
                                <h3 className="text-lg font-semibold mb-4">
                                    Campaign Performance ({data.campaigns.filter(c => c.wonDeals > 0).length} campaigns with WON deals)
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {/* SHOW ALL CAMPAIGNS WITH WON DEALS - NO SLICE! */}
                                    {data.campaigns
                                        .filter(campaign => campaign.wonDeals > 0)
                                        .map((campaign, i) => (
                                        <div key={i} className="bg-white p-4 rounded shadow">
                                            <h4 className="font-medium truncate mb-2">
                                                {campaign.campaignName || 'Unknown'}
                                            </h4>
                                            <div className="grid grid-cols-2 gap-2 text-sm">
                                                <div>🏆 {campaign.wonDeals || 0} won</div>
                                                <div>💰 {formatCurrency(campaign.revenue || 0)}</div>
                                                <div>👥 {campaign.contacts || 0} contacts</div>
                                                <div>📊 {campaign.conversionRate || 0}%</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                
                                {/* Campaign totals for verification */}
                                <div className="mt-4 p-3 bg-gray-100 rounded text-sm">
                                    Campaign Totals: 
                                    {' '}WON: {data.campaigns.reduce((sum, c) => sum + (c.wonDeals || 0), 0)}
                                    {' | '}Revenue: {formatCurrency(data.campaigns.reduce((sum, c) => sum + (c.revenue || 0), 0))}
                                    {' | '}Displayed Cards WON: {data.campaigns.filter(c => c.wonDeals > 0).reduce((sum, c) => sum + c.wonDeals, 0)}
                                </div>
                            </div>
                        </>
                    )}
                </div>
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    </script>
</body>
</html>