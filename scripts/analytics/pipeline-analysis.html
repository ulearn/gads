<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipeline Analysis Dashboard - Real HubSpot & Google Ads Data</title>
    
    <!-- Include React and ReactDOM from CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Include Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        .pipeline-stage {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .pipeline-stage:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .pipeline-arrow {
            width: 0;
            height: 0;
            border-left: 10px solid #3B82F6;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            margin: 0 8px;
        }
        .transition-arrow {
            background: linear-gradient(90deg, #8B5CF6, #F97316);
            border-radius: 20px;
            padding: 8px 16px;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .mql-gradient {
            background: linear-gradient(135deg, #8B5CF6, #3B82F6);
        }
        .sql-gradient {
            background: linear-gradient(135deg, #F97316, #EF4444);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen">
    <div id="root">
        <div class="min-h-screen flex items-center justify-center">
            <div class="text-center">
                <div class="text-4xl mb-4">üîÑ</div>
                <p class="text-lg text-gray-600">Loading Pipeline Analysis...</p>
            </div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const PipelineAnalysis = () => {
          const [dateRange, setDateRange] = useState('30');
          const [selectedCampaign, setSelectedCampaign] = useState('all');
          const [isLoading, setIsLoading] = useState(true);
          const [pipelineData, setPipelineData] = useState(null);
          const [error, setError] = useState(null);
          const [showProbabilityRefresh, setShowProbabilityRefresh] = useState(false);

          // Fetch data when filters change
          useEffect(() => {
            fetchPipelineData();
          }, [dateRange, selectedCampaign]);

          const fetchPipelineData = async () => {
            setIsLoading(true);
            setError(null);
            
            try {
              console.log(`‚ö° Fetching pipeline data: ${dateRange} days, campaign: ${selectedCampaign}`);
              
              // FIXED: Call the correct endpoint with the right path
              const response = await fetch(`/gads/analytics/pipeline-data?days=${dateRange}&campaign=${selectedCampaign}`);
              
              console.log(`üì° Response status: ${response.status}`);
              
              if (!response.ok) {
                const errorText = await response.text();
                console.error(`‚ùå HTTP Error ${response.status}:`, errorText);
                throw new Error(`HTTP ${response.status}: ${response.statusText}\n${errorText}`);
              }
              
              const result = await response.json();
              console.log(`üìä Raw API response:`, result);
              
              if (!result.success) {
                throw new Error(result.error || 'API returned error');
              }
              
              console.log('‚úÖ Pipeline data loaded successfully:', result);
              setPipelineData(result);

            } catch (err) {
              console.error('‚ùå Pipeline fetch error:', err);
              setError(`Pipeline Error: ${err.message}`);
            }
            
            setIsLoading(false);
          };

          const handleProbabilityRefresh = async () => {
            setShowProbabilityRefresh(true);
            try {
              const response = await fetch(`/gads/analytics/pipeline-probs?days=${dateRange}`);
              const result = await response.json();
              console.log('üìä Probability data refreshed:', result);
              // Refresh the main data after probability calculation
              await fetchPipelineData();
            } catch (err) {
              console.error('‚ùå Probability refresh failed:', err);
            }
            setShowProbabilityRefresh(false);
          };

          // Utility functions
          const formatNumber = (num) => {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(0) + 'K';
            return num.toLocaleString();
          };

          const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-EU', {
              style: 'currency',
              currency: 'EUR',
              minimumFractionDigits: 0,
              maximumFractionDigits: 0,
            }).format(amount || 0);
          };

          const formatPercentage = (value) => {
            return `${parseFloat(value || 0).toFixed(1)}%`;
          };

          // Loading state
          if (isLoading) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 flex items-center justify-center">
                <div className="text-center">
                  <div className="text-4xl mb-4">‚ö°</div>
                  <p className="text-lg text-gray-600">Loading Real Pipeline Data...</p>
                  <p className="text-sm text-gray-500 mt-2">MySQL Lightning Fast ‚ö°</p>
                </div>
              </div>
            );
          }

          // Error state
          if (error) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 flex items-center justify-center">
                <div className="text-center bg-white p-8 rounded-xl shadow-lg max-w-md">
                  <div className="text-red-500 text-4xl mb-4">‚ö†Ô∏è</div>
                  <h2 className="text-xl font-bold text-gray-900 mb-2">Pipeline Error</h2>
                  <p className="text-gray-600 mb-4">{error}</p>
                  <button 
                    className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors"
                    onClick={fetchPipelineData}
                  >
                    Retry Loading
                  </button>
                </div>
              </div>
            );
          }

          if (!pipelineData) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 flex items-center justify-center">
                <div className="text-center">
                  <div className="text-gray-500 text-4xl mb-4">üìä</div>
                  <p className="text-lg text-gray-600">No Pipeline Data Available</p>
                </div>
              </div>
            );
          }

          const { summary, mqlStages, sqlStages, campaigns } = pipelineData;

          return (
            <div className="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 p-6">
              
              {/* Header */}
              <div className="mb-8">
                <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                  <div>
                    <h1 className="text-3xl font-bold text-gray-900 mb-2">
                      üìä Pipeline Analysis Dashboard
                    </h1>
                    <p className="text-gray-600">
                      Real HubSpot & Google Ads Data from MySQL ({summary.period})
                    </p>
                  </div>
                  
                  {/* Controls */}
                  <div className="mt-4 lg:mt-0 grid grid-cols-1 md:grid-cols-3 gap-4">
                    
                    {/* Date Range */}
                    <div className="flex flex-col">
                      <label className="text-sm font-medium text-gray-700 mb-1">Date Range</label>
                      <select 
                        value={dateRange} 
                        onChange={(e) => setDateRange(e.target.value)}
                        className="bg-white border border-gray-300 rounded-lg px-3 py-2 text-gray-900 focus:ring-2 focus:ring-blue-500"
                      >
                        <option value="7">Last 7 days</option>
                        <option value="14">Last 14 days</option>
                        <option value="30">Last 30 days</option>
                        <option value="60">Last 60 days</option>
                        <option value="90">Last 90 days</option>
                      </select>
                    </div>

                    {/* Campaign Filter */}
                    <div className="flex flex-col">
                      <label className="text-sm font-medium text-gray-700 mb-1">Campaign</label>
                      <select 
                        value={selectedCampaign} 
                        onChange={(e) => setSelectedCampaign(e.target.value)}
                        className="bg-white border border-gray-300 rounded-lg px-3 py-2 text-gray-900 focus:ring-2 focus:ring-blue-500"
                      >
                        <option value="all">All Campaigns</option>
                        {campaigns.slice(0, 10).map((campaign, index) => (
                          <option key={index} value={campaign.name}>{campaign.name}</option>
                        ))}
                      </select>
                    </div>

                    {/* Probability Refresh */}
                    <div className="flex flex-col justify-end">
                      <button 
                        onClick={handleProbabilityRefresh}
                        disabled={showProbabilityRefresh}
                        className="bg-purple-500 hover:bg-purple-600 disabled:bg-purple-300 text-white px-4 py-2 rounded-lg transition-colors"
                      >
                        {showProbabilityRefresh ? 'üîÑ' : 'üìä'} 
                        {showProbabilityRefresh ? ' Refreshing...' : ' Refresh Probabilities'}
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              {/* Key Metrics Summary */}
              <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div className="bg-white rounded-lg p-6 shadow-lg">
                  <div className="text-sm text-gray-600">Campaign</div>
                  <div className="text-xl font-bold text-gray-900">{summary.campaign}</div>
                </div>
                <div className="bg-white rounded-lg p-6 shadow-lg">
                  <div className="text-sm text-gray-600">Total Contacts</div>
                  <div className="text-xl font-bold text-blue-600">{formatNumber(summary.totalContacts)}</div>
                </div>
                <div className="bg-white rounded-lg p-6 shadow-lg">
                  <div className="text-sm text-gray-600">Total Ad Spend</div>
                  <div className="text-xl font-bold text-green-600">{formatCurrency(summary.totalCost)}</div>
                </div>
                <div className="bg-white rounded-lg p-6 shadow-lg">
                  <div className="text-sm text-gray-600">Active Pipeline</div>
                  <div className="text-xl font-bold text-purple-600">{formatNumber(summary.active_deals)}</div>
                  <div className="text-xs text-gray-500 mt-1">
                    {formatNumber(summary.won_deals)} won ‚Ä¢ {formatNumber(summary.lost_deals)} lost
                  </div>
                </div>
              </div>

              {/* Pipeline Visualization */}
              <div className="bg-white rounded-xl shadow-lg p-8 mb-8">
                <h3 className="text-xl font-semibold text-gray-900 mb-6">
                  üîÑ Horizontal Pipeline Flow
                </h3>
                
                {/* MQL Stages (Google Ads) */}
                <div className="mb-8">
                  <h4 className="text-lg font-medium text-purple-600 mb-4 flex items-center gap-2">
                    <span>üéØ</span> MQL Stages (Google Ads Data)
                  </h4>
                  <div className="flex flex-wrap items-center gap-4 justify-center lg:justify-start">
                    
                    {/* Impressions */}
                    <div className="mql-gradient pipeline-stage rounded-lg p-4 min-w-[120px] text-center shadow-lg">
                      <h5 className="font-semibold text-white text-sm mb-2">Impressions</h5>
                      <div className="text-2xl font-bold text-white">{formatNumber(mqlStages.impressions.count)}</div>
                      <div className="text-xs text-purple-100 mt-1">Views</div>
                    </div>
                    
                    <div className="pipeline-arrow"></div>
                    
                    {/* Clicks */}
                    <div className="mql-gradient pipeline-stage rounded-lg p-4 min-w-[120px] text-center shadow-lg">
                      <h5 className="font-semibold text-white text-sm mb-2">Clicks</h5>
                      <div className="text-2xl font-bold text-white">{formatNumber(mqlStages.clicks.count)}</div>
                      <div className="text-xs text-purple-100 mt-1">CTR: {formatPercentage(mqlStages.clicks.ctr)}</div>
                    </div>
                    
                    <div className="pipeline-arrow"></div>
                    
                    {/* CTA Complete */}
                    <div className="mql-gradient pipeline-stage rounded-lg p-4 min-w-[120px] text-center shadow-lg">
                      <h5 className="font-semibold text-white text-sm mb-2">CTA Complete</h5>
                      <div className="text-2xl font-bold text-white">{formatNumber(mqlStages.ctaComplete.count)}</div>
                      <div className="text-xs text-purple-100 mt-1">CVR: {formatPercentage(mqlStages.ctaComplete.conversionRate)}</div>
                    </div>
                    
                    <div className="pipeline-arrow"></div>
                    
                    {/* Territory Validation */}
                    <div className="mql-gradient pipeline-stage rounded-lg p-4 min-w-[120px] text-center shadow-lg">
                      <h5 className="font-semibold text-white text-sm mb-2">Territory Check</h5>
                      <div className="text-2xl font-bold text-white">{formatNumber(mqlStages.territoryValidation.accepted)}</div>
                      <div className="text-xs text-purple-100 mt-1">
                        {formatNumber(mqlStages.territoryValidation.rejected)} rejected
                      </div>
                      <div className="text-xs text-purple-100 mt-1">
                        {formatPercentage(mqlStages.territoryValidation.rejectionRate)} burn rate
                      </div>
                    </div>
                  </div>
                </div>

                {/* Transition */}
                <div className="flex justify-center mb-8">
                  <div className="transition-arrow text-center">
                    <div className="text-sm">MQL ‚Üí SQL Transition</div>
                    <div className="text-xs opacity-75">
                      {formatNumber(mqlStages.territoryValidation.accepted)} contacts validated
                    </div>
                    <div className="text-xs opacity-75">
                      {formatPercentage(mqlStages.territoryValidation.rejectionRate)} burn rate
                    </div>
                  </div>
                </div>

                {/* SQL Stages (HubSpot) */}
                <div>
                  <h4 className="text-lg font-medium text-orange-600 mb-4 flex items-center gap-2">
                    <span>üìã</span> SQL Stages (HubSpot Pipeline)
                  </h4>
                  <div className="flex flex-wrap items-center gap-4 justify-center lg:justify-start">
                    
                    {Object.entries(sqlStages).filter(([stageKey, stageData]) => 
                      !['won', 'lost'].includes(stageKey) && 
                      parseInt(stageData.count || 0) > 0
                    ).map(([stageKey, stageData], index) => (
                      <React.Fragment key={stageKey}>
                        <div className="sql-gradient pipeline-stage rounded-lg p-4 min-w-[120px] text-center shadow-lg">
                          <h5 className="font-semibold text-white text-sm mb-2">{stageData.friendlyName || stageKey}</h5>
                          <div className="text-2xl font-bold text-white">{formatNumber(stageData.count)}</div>
                          <div className="text-xs text-orange-100 mt-1">{formatPercentage(stageData.percentage)}</div>
                          {stageData.value > 0 && (
                            <div className="text-xs text-orange-100 mt-1">{formatCurrency(stageData.value)}</div>
                          )}
                          {stageData.internalId && (
                            <div className="text-xs text-orange-200 mt-1 opacity-50">ID: {stageData.internalId}</div>
                          )}
                        </div>
                        {index < Object.entries(sqlStages).filter(([stageKey, stageData]) => 
                          !['won', 'lost'].includes(stageKey) && 
                          parseInt(stageData.count || 0) > 0
                        ).length - 1 && <div className="pipeline-arrow"></div>}
                      </React.Fragment>
                    ))}
                    
                    {/* Outcomes */}
                    {(parseInt(sqlStages.won?.count || 0) > 0 || parseInt(sqlStages.lost?.count || 0) > 0) && (
                      <>
                        <div className="pipeline-arrow"></div>
                        <div className="flex flex-col gap-2">
                          {parseInt(sqlStages.won?.count || 0) > 0 && (
                            <div className="bg-green-500 pipeline-stage rounded-lg p-3 min-w-[100px] text-center shadow-lg">
                              <h5 className="font-semibold text-white text-sm mb-1">WON</h5>
                              <div className="text-xl font-bold text-white">{formatNumber(sqlStages.won.count)}</div>
                              <div className="text-xs text-green-100">{formatCurrency(sqlStages.won.value)}</div>
                            </div>
                          )}
                          {parseInt(sqlStages.lost?.count || 0) > 0 && (
                            <div className="bg-red-500 pipeline-stage rounded-lg p-3 min-w-[100px] text-center shadow-lg">
                              <h5 className="font-semibold text-white text-sm mb-1">LOST</h5>
                              <div className="text-xl font-bold text-white">{formatNumber(sqlStages.lost.count)}</div>
                            </div>
                          )}
                        </div>
                      </>
                    )}
                  </div>
                </div>
              </div>

              {/* Data Quality & Source Info */}
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-6">
                <div className="flex items-center space-x-4">
                  <span className="text-blue-500 text-2xl">‚ö°</span>
                  <div>
                    <h4 className="text-lg font-semibold text-blue-900 mb-2">Data Source & Quality</h4>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                      <div>
                        <div className="font-medium text-blue-800">Google Ads Data</div>
                        <div className="text-blue-700">{summary.dataQuality.googleAdsRecords} from MySQL</div>
                      </div>
                      <div>
                        <div className="font-medium text-blue-800">HubSpot Contacts</div>
                        <div className="text-blue-700">{formatNumber(summary.dataQuality.hubspotContacts)} synced</div>
                      </div>
                      <div>
                        <div className="font-medium text-blue-800">Query Performance</div>
                        <div className="text-blue-700">{summary.dataQuality.dataSource}</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Footer */}
              <div className="mt-8 text-center text-sm text-gray-500">
                <p>Dashboard updated: {new Date().toLocaleString()} | 
                   Campaign: {summary.campaign} | 
                   Period: {summary.period}</p>
                <p className="mt-1">Real-time MySQL data | Active Deals: {formatNumber(summary.active_deals)} | 
                   Total Revenue: {formatCurrency(summary.total_value)}</p>
              </div>
            </div>
          );
        };
        
        // Render the component
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(PipelineAnalysis));
    </script>
</body>
</html>