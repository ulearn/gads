<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipeline Analysis Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .dashboard-container {
            width: 100vw;
            min-width: 100vw;
            margin: 0;
            background: white;
            border-radius: 0;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header-left h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-left .subtitle {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-size: 12px;
            opacity: 0.9;
        }
        
        select, .refresh-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        
        select {
            background: rgba(255,255,255,0.2);
            color: white;
            backdrop-filter: blur(10px);
        }
        
        select option {
            background: #333;
            color: white;
        }
        
        .refresh-btn {
            background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(168, 85, 247, 0.3);
        }
        
        .dashboard-content {
            padding: 30px;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        
        .summary-card h3 {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .summary-card .value {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 5px;
        }
        
        .summary-card .subtitle {
            font-size: 12px;
            color: #64748b;
        }
        
        /* SIMPLE PIPELINE FLOW */
        .pipeline-section {
            margin-bottom: 40px;
        }
        
        .pipeline-section h2 {
            font-size: 20px;
            color: #1e293b;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .simple-pipeline {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
            padding: 20px 10px;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border-radius: 15px;
            overflow-x: auto;
            height: 55vh;
            min-height: 300px;
            width: 100%;
        }
        
        /* PIPELINE STAGES - SIMPLE BOXES */
        .pipeline-stage {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            text-align: center;
            position: relative;
            border: 3px solid;
            transition: all 0.3s ease;
            margin: 0 -1px; /* Slight overlap for clean connection */
        }
        
        .pipeline-stage:hover {
            transform: scale(1.05);
            z-index: 10;
        }
        
        /* STAGE SIZING - ALL STAGES INCLUDED, TALLER BOXES FOR BETTER VISUAL IMPACT */
        .stage-impressions {
            background: #4F46E5;
            border-color: #3730A3;
            width: 140px;
            height: 200px;
            border-radius: 8px 0 0 8px;
        }
        
        .stage-clicks {
            background: #3B82F6;
            border-color: #2563EB;
            width: 120px;
            height: 180px;
        }
        
        .stage-cta {
            background: #0EA5E9;
            border-color: #0284C7;
            width: 100px;
            height: 160px;
        }
        
        .stage-territory-pass {
            background: #8B5CF6;
            border-color: #7C3AED;
            width: 90px;
            height: 140px;
        }
        
        .stage-valid-sql {
            background: #EC4899;
            border-color: #DB2777;
            width: 80px;
            height: 120px;
        }
        
        .stage-inbox {
            background: #F97316;
            border-color: #EA580C;
            width: 85px;
            height: 130px;
        }
        
        .stage-sequenced {
            background: #EF4444;
            border-color: #DC2626;
            width: 95px;
            height: 150px;
        }
        
        .stage-engaging {
            background: #DC2626;
            border-color: #B91C1C;
            width: 105px;
            height: 170px;
        }
        
        .stage-responsive {
            background: #B91C1C;
            border-color: #991B1B;
            width: 115px;
            height: 180px;
        }
        
        .stage-advising {
            background: #991B1B;
            border-color: #7F1D1D;
            width: 125px;
            height: 190px;
        }
        
        .stage-negotiation {
            background: #7F1D1D;
            border-color: #450A0A;
            width: 135px;
            height: 200px;
        }
        
        .stage-trial {
            background: #B45309;
            border-color: #92400E;
            width: 110px;
            height: 175px;
        }
        
        .stage-contract {
            background: #92400E;
            border-color: #78350F;
            width: 120px;
            height: 185px;
        }
        
        /* FINAL STAGES - EQUAL SIZE FORK, TALLER */
        .final-stages {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .stage-won {
            background: #059669;
            border-color: #047857;
            width: 90px;
            height: 99px;
            border-radius: 0 8px 0 0;
        }
        
        .stage-lost {
            background: #6B7280;
            border-color: #4B5563;
            width: 90px;
            height: 99px;
            border-radius: 0 0 8px 0;
        }
        
        /* STAGE CONTENT - ADJUSTED FOR TALLER BOXES */
        .stage-number {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .stage-label {
            font-size: 11px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            line-height: 1.2;
            padding: 0 5px;
        }
        
        /* NO ARROWS - CLEAN CONNECTED FLOW */
        
        /* RESPONSIVE - ADJUSTED FOR TALLER BOXES */
        @media (max-width: 1400px) {
            .simple-pipeline {
                gap: 0;
                padding: 15px 5px;
                justify-content: center;
                height: 45vh;
                min-height: 250px;
            }
            
            .stage-impressions { width: 120px; height: 170px; }
            .stage-clicks { width: 105px; height: 155px; }
            .stage-cta { width: 90px; height: 140px; }
            .stage-territory-pass { width: 80px; height: 125px; }
            .stage-valid-sql { width: 70px; height: 110px; }
            .stage-inbox { width: 75px; height: 115px; }
            .stage-sequenced { width: 85px; height: 130px; }
            .stage-engaging { width: 95px; height: 145px; }
            .stage-responsive { width: 105px; height: 155px; }
            .stage-advising { width: 115px; height: 165px; }
            .stage-negotiation { width: 125px; height: 170px; }
            .stage-trial { width: 100px; height: 150px; }
            .stage-contract { width: 110px; height: 160px; }
            .stage-won, .stage-lost { width: 80px; height: 84px; }
        }
        
        @media (max-width: 768px) {
            .simple-pipeline {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }
            
            .pipeline-stage {
                margin: 0;
                border-radius: 8px !important;
            }
            
            .final-stages {
                flex-direction: row;
                gap: 10px;
            }
        }
        
        .data-quality {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            padding: 20px;
            border-radius: 12px;
            margin-top: 30px;
        }
        
        .data-quality h3 {
            color: #1e293b;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .quality-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .quality-metric {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }
        
        .quality-metric .label {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 5px;
        }
        
        .quality-metric .value {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #64748b;
        }
        
        .error {
            background: #fee2e2;
            color: #dc2626;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function PipelineDashboard() {
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [dateRange, setDateRange] = useState('30');
            const [campaign, setCampaign] = useState('all');

            const fetchData = async () => {
                try {
                    setLoading(true);
                    setError(null);
                    
                    const response = await fetch(`/gads/analytics/pipeline-data?days=${dateRange}&campaign=${campaign}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        setData(result);
                    } else {
                        throw new Error(result.error || 'Failed to fetch data');
                    }
                } catch (err) {
                    console.error('Fetch error:', err);
                    setError(err.message);
                    // Mock data with your actual numbers
                    setData({
                        success: true,
                        summary: {
                            campaign: campaign === 'all' ? 'All Campaigns' : campaign,
                            totalContacts: 184,
                            contactsWithDeals: 99,
                            period: `Last ${dateRange} days`,
                            totalCost: 2705.06,
                            active_deals: 50,
                            won_deals: 1,
                            lost_deals: 33
                        },
                        mqlStages: {
                            impressions: { count: 59988 },
                            clicks: { count: 47286, ctr: '1.47%' },
                            ctaComplete: { count: 184, conversionRate: '0.39%' },
                            territoryValidation: { accepted: 99, rejected: 85, rejectionRate: '46.2%' }
                        },
                        sqlStages: {
                            inbox: { count: 0, percentage: '0%', friendlyName: 'INBOX' },
                            sequenced: { count: 36, percentage: '72%', friendlyName: 'SEQUENCED' },
                            engaging: { count: 12, percentage: '24%', friendlyName: 'ENGAGING' },
                            responsive: { count: 2, percentage: '4%', friendlyName: 'RESPONSIVE' },
                            advising: { count: 0, percentage: '0%', friendlyName: 'ADVISING' },
                            contract: { count: 0, percentage: '0%', friendlyName: 'CONTRACT' },
                            won: { count: 1, percentage: '2%', friendlyName: 'WON' },
                            lost: { count: 33, percentage: '66%', friendlyName: 'LOST' }
                        },
                        campaigns: []
                    });
                } finally {
                    setLoading(false);
                }
            };

            const refreshProbabilities = async () => {
                try {
                    await fetch(`/gads/analytics/prob?days=${dateRange}`);
                    alert('Probabilities refreshed! The pipeline analysis has been updated with the latest data.');
                    fetchData();
                } catch (err) {
                    alert('Failed to refresh probabilities: ' + err.message);
                }
            };

            useEffect(() => {
                fetchData();
            }, [dateRange, campaign]);

            if (loading) {
                return (
                    <div className="dashboard-container">
                        <div className="loading">
                            <i className="fas fa-spinner fa-spin"></i> Loading pipeline data...
                        </div>
                    </div>
                );
            }

            if (error && !data) {
                return (
                    <div className="dashboard-container">
                        <div className="error">
                            <strong>Error:</strong> {error}
                        </div>
                    </div>
                );
            }

            const summary = data?.summary || {};
            const mql = data?.mqlStages || {};
            const sql = data?.sqlStages || {};

            return (
                <div className="dashboard-container">
                    <div className="dashboard-header">
                        <div className="header-left">
                            <h1><i className="fas fa-chart-line"></i> Pipeline Analysis Dashboard</h1>
                            <div className="subtitle">Real HubSpot & Google Ads Data from MySQL (Last {dateRange} days)</div>
                        </div>
                        <div className="header-controls">
                            <div className="control-group">
                                <label>Date Range</label>
                                <select value={dateRange} onChange={(e) => setDateRange(e.target.value)}>
                                    <option value="7">Last 7 days</option>
                                    <option value="14">Last 14 days</option>
                                    <option value="30">Last 30 days</option>
                                    <option value="60">Last 60 days</option>
                                    <option value="90">Last 90 days</option>
                                </select>
                            </div>
                            <div className="control-group">
                                <label>Campaign</label>
                                <select value={campaign} onChange={(e) => setCampaign(e.target.value)}>
                                    <option value="all">All Campaigns</option>
                                    {data?.campaigns?.map(c => (
                                        <option key={c.id} value={c.name}>{c.name}</option>
                                    ))}
                                </select>
                            </div>
                            <button className="refresh-btn" onClick={refreshProbabilities}>
                                <i className="fas fa-sync-alt"></i> Refresh Probabilities
                            </button>
                        </div>
                    </div>

                    <div className="dashboard-content">
                        <div className="summary-cards">
                            <div className="summary-card">
                                <h3>Campaign</h3>
                                <div className="value">{summary.campaign}</div>
                            </div>
                            <div className="summary-card">
                                <h3>Total Contacts</h3>
                                <div className="value">{summary.totalContacts?.toLocaleString() || 0}</div>
                            </div>
                            <div className="summary-card">
                                <h3>Total Ad Spend</h3>
                                <div className="value">€{summary.totalCost?.toLocaleString() || 0}</div>
                            </div>
                            <div className="summary-card">
                                <h3>Active Pipeline</h3>
                                <div className="value">{summary.active_deals || 0}</div>
                                <div className="subtitle">{summary.won_deals || 0} won • {summary.lost_deals || 0} lost</div>
                            </div>
                        </div>

                        <div className="pipeline-section">
                            <h2><i className="fas fa-route"></i> Simple Pipeline Flow</h2>
                            <div className="simple-pipeline">
                                
                                <div className="pipeline-stage stage-impressions">
                                    <div className="stage-number">{(mql.impressions?.count || 0).toLocaleString()}</div>
                                    <div className="stage-label">IMPRESSIONS</div>
                                </div>
                                
                                <div className="pipeline-stage stage-clicks">
                                    <div className="stage-number">{(mql.clicks?.count || 0).toLocaleString()}</div>
                                    <div className="stage-label">CLICKS</div>
                                </div>
                                
                                <div className="pipeline-stage stage-cta">
                                    <div className="stage-number">{(mql.ctaComplete?.count || 0).toLocaleString()}</div>
                                    <div className="stage-label">CTA</div>
                                </div>
                                
                                <div className="pipeline-stage stage-territory-pass">
                                    <div className="stage-number">{mql.territoryValidation?.accepted || 0}</div>
                                    <div className="stage-label">TERRITORY PASS</div>
                                </div>
                                
                                <div className="pipeline-stage stage-valid-sql">
                                    <div className="stage-number">{mql.territoryValidation?.accepted || 0}</div>
                                    <div className="stage-label">VALID SQL</div>
                                </div>
                                
                                <div className="pipeline-stage stage-inbox">
                                    <div className="stage-number">{sql.inbox?.count || 0}</div>
                                    <div className="stage-label">INBOX</div>
                                </div>
                                
                                <div className="pipeline-stage stage-sequenced">
                                    <div className="stage-number">{sql.sequenced?.count || 0}</div>
                                    <div className="stage-label">SEQUENCED</div>
                                </div>
                                
                                <div className="pipeline-stage stage-engaging">
                                    <div className="stage-number">{sql.engaging?.count || 0}</div>
                                    <div className="stage-label">ENGAGING</div>
                                </div>
                                
                                <div className="pipeline-stage stage-responsive">
                                    <div className="stage-number">{sql.responsive?.count || 0}</div>
                                    <div className="stage-label">RESPONSIVE</div>
                                </div>
                                
                                <div className="pipeline-stage stage-advising">
                                    <div className="stage-number">{sql.advising?.count || 0}</div>
                                    <div className="stage-label">ADVISING</div>
                                </div>
                                
                                <div className="pipeline-stage stage-negotiation">
                                    <div className="stage-number">{sql.consideration_and_negotiation?.count || 0}</div>
                                    <div className="stage-label">NEGOTIATION</div>
                                </div>
                                
                                <div className="pipeline-stage stage-trial">
                                    <div className="stage-number">{sql.trial?.count || 0}</div>
                                    <div className="stage-label">TRIAL</div>
                                </div>
                                
                                <div className="pipeline-stage stage-contract">
                                    <div className="stage-number">{sql.contract?.count || 0}</div>
                                    <div className="stage-label">CONTRACT</div>
                                </div>
                                
                                <div className="final-stages">
                                    <div className="pipeline-stage stage-won">
                                        <div className="stage-number">{sql.won?.count || 0}</div>
                                        <div className="stage-label">WON</div>
                                    </div>
                                    <div className="pipeline-stage stage-lost">
                                        <div className="stage-number">{sql.lost?.count || 0}</div>
                                        <div className="stage-label">LOST</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="data-quality">
                            <h3><i className="fas fa-database"></i> Data Source & Quality</h3>
                            <div className="quality-metrics">
                                <div className="quality-metric">
                                    <div className="label">Google Ads Data</div>
                                    <div className="value">26,440+ metrics from MySQL</div>
                                </div>
                                <div className="quality-metric">
                                    <div className="label">HubSpot Contacts</div>
                                    <div className="value">{summary.totalContacts || 0} synced</div>
                                </div>
                                <div className="quality-metric">
                                    <div className="label">Query Performance</div>
                                    <div className="value">MySQL Oracle-Aligned ⚡</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<PipelineDashboard />, document.getElementById('root'));
    </script>
</body>
</html>